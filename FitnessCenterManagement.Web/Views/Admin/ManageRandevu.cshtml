@model IEnumerable<FitnessCenterManagement.Web.Models.Randevu>

@{
    ViewData["Title"] = "Randevu Yönetimi";
}

<!-- Sayfa Başlığı -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="h2">
                <i class="fas fa-calendar-check"></i> Randevu Yönetimi
            </h1>
            <p class="text-muted">Tüm randevuları görüntüleyin ve yönetin</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Index", "Randevu")" class="btn btn-primary">
                <i class="fas fa-plus"></i> Yeni Randevu
            </a>
        </div>
    </div>
</div>

<!-- Durum Filtreleme -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Durum Filtresi</label>
                <select class="form-select" id="statusFilter">
                    <option value="">Tümü</option>
                    <option value="Beklemede">Beklemede</option>
                    <option value="Onaylı">Onaylı</option>
                    <option value="Reddedildi">Reddedildi</option>
                    <option value="İptal Edildi">İptal Edildi</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tarih Aralığı</label>
                <input type="date" class="form-control" id="dateFilter">
            </div>
            <div class="col-md-3 align-self-end">
                <button class="btn btn-outline-secondary w-100" id="filterBtn">
                    <i class="fas fa-filter"></i> Filtrele
                </button>
            </div>
            <div class="col-md-3 align-self-end">
                <button class="btn btn-outline-secondary w-100" id="resetBtn">
                    <i class="fas fa-redo"></i> Sıfırla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Randevular Tablosu -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">Randevular Listesi</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Üye</th>
                    <th>Antrenör</th>
                    <th>Hizmet</th>
                    <th>Başlama Tarihi</th>
                    <th>Bitiş Tarihi</th>
                    <th>Ücret</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody id="randevuTableBody">
                @if (Model != null && Model.Any())
                {
                    @foreach (var randevu in Model)
                    {
                        <tr data-id="@randevu.Id" data-durum="@randevu.Durum">
                            <td>
                                <strong>#@randevu.Id</strong>
                            </td>
                            <td>
                                @if (randevu.Uye != null)
                                {
                                    <span>@randevu.Uye.Ad @randevu.Uye.Soyad</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (randevu.Antrenor != null)
                                {
                                    <span>@randevu.Antrenor.Ad @randevu.Antrenor.Soyad</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (randevu.Hizmet != null)
                                {
                                    <span>@randevu.Hizmet.Ad</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <small>@randevu.BaslamaTarihi.ToString("dd.MM.yyyy HH:mm")</small>
                            </td>
                            <td>
                                <small>@randevu.BitisTarihi.ToString("dd.MM.yyyy HH:mm")</small>
                            </td>
                            <td>
                                <strong>@randevu.Ucret.ToString("C2")</strong>
                            </td>
                            <td>
                                @{
                                    var durum = randevu.Durum;
                                    var badgeClass = durum switch
                                    {
                                        "Beklemede" => "bg-warning",
                                        "Onaylı" => "bg-success",
                                        "Reddedildi" => "bg-danger",
                                        "İptal Edildi" => "bg-secondary",
                                        _ => "bg-info"
                                    };
                                }
                                <span class="badge @badgeClass">@durum</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="@Url.Action("Details", "Randevu", new { id = randevu.Id })" class="btn btn-outline-primary" title="Detaylar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Edit", "Randevu", new { id = randevu.Id })" class="btn btn-outline-info" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    @if (randevu.Durum == "Beklemede")
                                    {
                                        <button type="button" class="btn btn-outline-success approve-btn" data-id="@randevu.Id" title="Onayla">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger reject-btn" data-id="@randevu.Id" title="Reddet">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Randevu bulunamadı</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- İstatistikler -->
<div class="row mt-4">
    <div class="col-md-6 col-lg-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-title text-muted">Toplam Randevu</h6>
                <h3 id="totalCount">@(Model?.Count() ?? 0)</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-title text-muted">Beklemede</h6>
                <h3 class="text-warning" id="pendingCount">@(Model?.Count(r => r.Durum == "Beklemede") ?? 0)</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-title text-muted">Onaylı</h6>
                <h3 class="text-success" id="approvedCount">@(Model?.Count(r => r.Durum == "Onaylı") ?? 0)</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-title text-muted">Reddedildi</h6>
                <h3 class="text-danger" id="rejectedCount">@(Model?.Count(r => r.Durum == "Reddedildi") ?? 0)</h3>
            </div>
        </div>
    </div>
</div>

<!-- Onay/Reddetme Modal -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionTitle">Randevu Durumu Güncelle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="actionBody">
                Randevu durumunu güncellemek istediğinize emin misiniz?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Onayla</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentAction = null;
        let currentRandevuId = null;

        // Onayla Butonu
        document.querySelectorAll('.approve-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                currentRandevuId = this.dataset.id;
                currentAction = 'Onaylı';
                document.getElementById('actionTitle').textContent = 'Randevu Onay';
                document.getElementById('actionBody').textContent = 'Bu randevuyu onaylamak istediğinize emin misiniz?';
                document.getElementById('confirmActionBtn').className = 'btn btn-success';
                new bootstrap.Modal(document.getElementById('actionModal')).show();
            });
        });

        // Reddet Butonu
        document.querySelectorAll('.reject-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                currentRandevuId = this.dataset.id;
                currentAction = 'Reddedildi';
                document.getElementById('actionTitle').textContent = 'Randevu Reddetme';
                document.getElementById('actionBody').textContent = 'Bu randevuyu reddetmek istediğinize emin misiniz?';
                document.getElementById('confirmActionBtn').className = 'btn btn-danger';
                new bootstrap.Modal(document.getElementById('actionModal')).show();
            });
        });

        // Onay/Reddetme İşlemini Gönder
        document.getElementById('confirmActionBtn').addEventListener('click', async function () {
            try {
                const response = await fetch(`/Admin/UpdateRandevuStatus?id=${currentRandevuId}&durum=${currentAction}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Sayfayı yenile
                    location.reload();
                } else {
                    alert('Hata: İşlem başarısız oldu');
                }
            } catch (error) {
                console.error('Hata:', error);
                alert('Hata: ' + error.message);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        });

        // Filtre Butonu
        document.getElementById('filterBtn').addEventListener('click', function () {
            const status = document.getElementById('statusFilter').value;
            const date = document.getElementById('dateFilter').value;
            
            const rows = document.querySelectorAll('#randevuTableBody tr');
            rows.forEach(row => {
                let show = true;
                
                if (status && row.dataset.durum !== status) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        });

        // Sıfırla Butonu
        document.getElementById('resetBtn').addEventListener('click', function () {
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            
            const rows = document.querySelectorAll('#randevuTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        });
    </script>
}
