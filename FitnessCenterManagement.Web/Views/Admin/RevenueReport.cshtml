@{
    ViewData["Title"] = "Gelir Raporu";
}

<!-- Sayfa Başlığı -->
<div class="page-header mb-4">
    <h1 class="h2">
        <i class="fas fa-chart-line"></i> Gelir Raporu
    </h1>
    <p class="text-muted">Sistem gelir analizi ve istatistikleri</p>
</div>

<!-- Toplam Gelir Kartı -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h5 class="card-title text-muted mb-3">Toplam Gelir (Onaylı Randevular)</h5>
                <h2 class="text-success">
                    <strong>@(ViewBag.ToplamGelir?.ToString("C2") ?? "0,00 ₺")</strong>
                </h2>
                <small class="text-muted">
                    Sistem tarafından oluşturulan tüm onaylı randevuların toplam geliri
                </small>
            </div>
        </div>
    </div>

    <!-- Tarih Aralığı Seçimi -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-muted mb-3">Raporlamak İçin Tarih Seçin</h6>
                <div class="mb-3">
                    <label class="form-label">Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <button class="btn btn-primary w-100" id="filterReportBtn">
                    <i class="fas fa-filter"></i> Filtrele
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hizmet Bazında Gelir -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-spa"></i> Hizmet Bazında Gelir
        </h5>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead class="table-light">
                <tr>
                    <th>Hizmet Adı</th>
                    <th class="text-end">Randevu Sayısı</th>
                    <th class="text-end">Toplam Gelir</th>
                    <th class="text-end">Ortalama Gelir</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.HizmetGelir != null && ViewBag.HizmetGelir.Count > 0)
                {
                    @foreach (var hizmet in ViewBag.HizmetGelir)
                    {
                        <tr>
                            <td>
                                <strong>@hizmet.hizmetAdi</strong>
                            </td>
                            <td class="text-end">
                                <span class="badge bg-info">@hizmet.randevuSayisi</span>
                            </td>
                            <td class="text-end">
                                <strong class="text-success">@hizmet.toplamGelir.ToString("C2")</strong>
                            </td>
                            <td class="text-end">
                                @{
                                    decimal ortalamaGelir = hizmet.randevuSayisi > 0 
                                        ? hizmet.toplamGelir / hizmet.randevuSayisi 
                                        : 0;
                                }
                                <small class="text-muted">@ortalamaGelir.ToString("C2")</small>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            Hizmet gelir verisi bulunamadı
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Antrenör Bazında Gelir -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-user-tie"></i> Antrenör Bazında Gelir
        </h5>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead class="table-light">
                <tr>
                    <th>Antrenör Adı</th>
                    <th class="text-end">Randevu Sayısı</th>
                    <th class="text-end">Toplam Gelir</th>
                    <th class="text-end">Ortalama Gelir</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.AntrenorGelir != null && ViewBag.AntrenorGelir.Count > 0)
                {
                    @foreach (var antrenor in ViewBag.AntrenorGelir)
                    {
                        <tr>
                            <td>
                                <strong>@antrenor.antrenorAdi</strong>
                            </td>
                            <td class="text-end">
                                <span class="badge bg-info">@antrenor.randevuSayisi</span>
                            </td>
                            <td class="text-end">
                                <strong class="text-success">@antrenor.toplamGelir.ToString("C2")</strong>
                            </td>
                            <td class="text-end">
                                @{
                                    decimal ortalamaGelir = antrenor.randevuSayisi > 0 
                                        ? antrenor.toplamGelir / antrenor.randevuSayisi 
                                        : 0;
                                }
                                <small class="text-muted">@ortalamaGelir.ToString("C2")</small>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            Antrenör gelir verisi bulunamadı
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Grafikler Bölümü (İsteğe bağlı) -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Hizmet Dağılımı</h6>
            </div>
            <div class="card-body">
                <canvas id="serviceChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Antrenör Dağılımı</h6>
            </div>
            <div class="card-body">
                <canvas id="trainerChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Rapor İndirme Butonu -->
<div class="mt-4">
    <button class="btn btn-success" id="downloadReportBtn">
        <i class="fas fa-download"></i> Raporu İndir (PDF)
    </button>
    <button class="btn btn-info" id="printReportBtn">
        <i class="fas fa-print"></i> Yazdır
    </button>
</div>

@section Scripts {
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Hizmet Gelir Verisi
        const hizmetVerisi = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.HizmetGelir ?? new List<object>()));
        const hizmetAdi = hizmetVerisi.map(h => h.hizmetAdi);
        const hizmetGelir = hizmetVerisi.map(h => h.toplamGelir);

        // Hizmet Grafiği
        const serviceCtx = document.getElementById('serviceChart');
        if (serviceCtx && hizmetVerisi.length > 0) {
            new Chart(serviceCtx, {
                type: 'doughnut',
                data: {
                    labels: hizmetAdi,
                    datasets: [{
                        data: hizmetGelir,
                        backgroundColor: [
                            '#0d6efd', '#198754', '#0dcaf0', '#ffc107', '#dc3545',
                            '#6f42c1', '#fd7e14', '#20c997'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed + ' ₺';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Antrenör Gelir Verisi
        const antrenorVerisi = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.AntrenorGelir ?? new List<object>()));
        const antrenorAdi = antrenorVerisi.map(a => a.antrenorAdi);
        const antrenorGelir = antrenorVerisi.map(a => a.toplamGelir);

        // Antrenör Grafiği
        const trainerCtx = document.getElementById('trainerChart');
        if (trainerCtx && antrenorVerisi.length > 0) {
            new Chart(trainerCtx, {
                type: 'bar',
                data: {
                    labels: antrenorAdi,
                    datasets: [{
                        label: 'Toplam Gelir',
                        data: antrenorGelir,
                        backgroundColor: '#198754',
                        borderColor: '#0d6efd',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.parsed.x + ' ₺';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filtre Butonu
        document.getElementById('filterReportBtn').addEventListener('click', function () {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                window.location.href = `/Admin/RevenueReport?startDate=${startDate}&endDate=${endDate}`;
            } else {
                alert('Lütfen başlangıç ve bitiş tarihini seçiniz');
            }
        });

        // PDF İndir Butonu
        document.getElementById('downloadReportBtn').addEventListener('click', function () {
            alert('PDF indirme özelliği yakında eklenecektir');
            // TODO: Implement PDF download
        });

        // Yazdır Butonu
        document.getElementById('printReportBtn').addEventListener('click', function () {
            window.print();
        });
    </script>
}
